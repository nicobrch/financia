name: Terraform Apply (Prod)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "apply-prod" to confirm deployment to PRODUCTION'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  terraform-apply:
    name: Terraform Apply - Prod
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Validate Confirmation
        if: ${{ github.event.inputs.confirm != 'apply-prod' }}
        run: |
          echo "âŒ Confirmation failed. You must type 'apply-prod' to proceed with PRODUCTION deployment."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SA_EMAIL_PROD }}
          token_format: 'access_token'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Check if Docker image exists
        id: check_image
        run: |
          IMAGE="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/financia/api:latest"
          if gcloud artifacts docker images describe $IMAGE --format="get(name)" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Docker image exists: $IMAGE"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Docker image not found: $IMAGE"
            echo "Please build and push the Docker image first using the docker-build workflow"
            exit 1
          fi

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init -backend-config=environments/prod/backend.hcl

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var-file=environments/prod/terraform.tfvars \
            -var="project_id=${{ secrets.GCP_PROJECT_ID_PROD }}" \
            -var="whatsapp_api_key=${{ secrets.WHATSAPP_API_KEY_PROD }}" \
            -var="gemini_api_key=${{ secrets.GEMINI_API_KEY_PROD }}" \
            -var="google_client_id=${{ secrets.GOOGLE_CLIENT_ID_PROD }}" \
            -var="google_client_secret=${{ secrets.GOOGLE_CLIENT_SECRET_PROD }}" \
            -var="google_refresh_token=${{ secrets.GOOGLE_REFRESH_TOKEN_PROD }}" \
            -var="spreadsheet_id=${{ secrets.SPREADSHEET_ID_PROD }}" \
            -var="whatsapp_webhook_verify_token=${{ secrets.WHATSAPP_WEBHOOK_VERIFY_TOKEN_PROD }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve tfplan

      - name: Terraform Output
        id: output
        working-directory: ./terraform
        run: |
          echo "service_url=$(terraform output -raw service_url)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw service_name)" >> $GITHUB_OUTPUT

      - name: Wait for Service to be Ready
        run: |
          echo "Waiting 30 seconds for service to be fully deployed..."
          sleep 30

      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests against production..."

          # Test health endpoint
          HEALTH_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.output.outputs.service_url }}/health)
          if [ $HEALTH_CODE -ne 200 ]; then
            echo "âŒ Health check failed with status $HEALTH_CODE"
            exit 1
          fi
          echo "âœ… Health check passed"

          # Test webhook verification
          WEBHOOK_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.output.outputs.service_url }}/webhook?hub.mode=subscribe&hub.verify_token=${{ secrets.WHATSAPP_WEBHOOK_VERIFY_TOKEN }}&hub.challenge=test123")
          if [ $WEBHOOK_CODE -ne 200 ]; then
            echo "âš ï¸  Webhook verification test returned $WEBHOOK_CODE (this may be expected)"
          else
            echo "âœ… Webhook verification passed"
          fi

      - name: Create Deployment Summary
        run: |
          echo "## âœ… Terraform Apply Successful (Production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** ${{ steps.output.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service Name:** ${{ steps.output.outputs.service_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Post-Deployment Tasks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Smoke tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify WhatsApp webhook: \`${{ steps.output.outputs.service_url }}/webhook\`" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Monitor logs: [Cloud Logging](https://console.cloud.google.com/logs)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check metrics: [Cloud Monitoring](https://console.cloud.google.com/monitoring)" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Terraform Apply Failed (Production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš¨ **CRITICAL: Production deployment failed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details and consider rolling back." >> $GITHUB_STEP_SUMMARY
