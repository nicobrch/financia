# Infrastructure Architecture Diagram

## ğŸ—ï¸ Complete Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           GitHub Repository                              â”‚
â”‚                         github.com/nicobrch/financia                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   terraform/ â”‚  â”‚    .github/  â”‚  â”‚     app/     â”‚  â”‚    docs/    â”‚â”‚
â”‚  â”‚   (IaC)      â”‚  â”‚  workflows/  â”‚  â”‚  (Python)    â”‚  â”‚  (Guides)   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Pull Request / Push
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GitHub Actions                                    â”‚
â”‚                    (CI/CD Automation)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Pull Request Event                                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ Checkout code                                                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ Authenticate via OIDC (no keys!)                               â”‚ â”‚
â”‚  â”‚  â”œâ”€ Run terraform plan                                              â”‚ â”‚
â”‚  â”‚  â””â”€ Post plan output as PR comment                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Manual Workflow Trigger (terraform apply)                         â”‚ â”‚
â”‚  â”‚  â”œâ”€ Require explicit confirmation ("apply" or "apply-prod")        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Require human approval (prod only)                             â”‚ â”‚
â”‚  â”‚  â”œâ”€ Authenticate via OIDC                                           â”‚ â”‚
â”‚  â”‚  â”œâ”€ Run terraform apply                                             â”‚ â”‚
â”‚  â”‚  â”œâ”€ Deploy to Cloud Run                                             â”‚ â”‚
â”‚  â”‚  â””â”€ Run smoke tests                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                           â”‚
â”‚  Generates: GitHub OIDC Token                                            â”‚
â”‚  Claims:                                                                  â”‚
â”‚    - repository: nicobrch/financia                                       â”‚
â”‚    - actor: @nicobrch                                                    â”‚
â”‚    - repository_owner: nicobrch                                          â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ OIDC Token
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  GCP Workload Identity Federation                         â”‚
â”‚                    (Keyless Authentication)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Workload Identity Pool: github-actions-pool                     â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚  Provider: github-oidc-provider                                  â”‚   â”‚
â”‚  â”‚    â”œâ”€ Issuer: https://token.actions.githubusercontent.com        â”‚   â”‚
â”‚  â”‚    â”œâ”€ Audience: GCP project                                      â”‚   â”‚
â”‚  â”‚    â””â”€ Attribute mapping:                                         â”‚   â”‚
â”‚  â”‚        â€¢ google.subject = assertion.sub                          â”‚   â”‚
â”‚  â”‚        â€¢ attribute.repository = assertion.repository             â”‚   â”‚
â”‚  â”‚        â€¢ attribute.actor = assertion.actor                       â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚  Attribute Condition:                                            â”‚   â”‚
â”‚  â”‚    assertion.repository_owner == 'nicobrch'                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  Validates token â†’ Grants short-lived access to Service Accounts         â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                              â”‚
             â”‚ Dev Environment              â”‚ Prod Environment
             â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  terraform-dev@          â”‚  â”‚  terraform-prod@         â”‚
â”‚  dev-ai-agents...        â”‚  â”‚  dev-ai-agents...        â”‚
â”‚                          â”‚  â”‚                          â”‚
â”‚  Roles:                  â”‚  â”‚  Roles:                  â”‚
â”‚  â€¢ run.admin             â”‚  â”‚  â€¢ run.admin             â”‚
â”‚  â€¢ iam.serviceAccount    â”‚  â”‚  â€¢ iam.serviceAccount    â”‚
â”‚    Admin                 â”‚  â”‚    Admin                 â”‚
â”‚  â€¢ secretmanager.admin   â”‚  â”‚  â€¢ secretmanager.admin   â”‚
â”‚  â€¢ storage.admin         â”‚  â”‚  â€¢ storage.admin         â”‚
â”‚  â€¢ logging.admin         â”‚  â”‚  â€¢ logging.admin         â”‚
â”‚  â€¢ monitoring.admin      â”‚  â”‚  â€¢ monitoring.admin      â”‚
â”‚  â€¢ artifactregistry      â”‚  â”‚  â€¢ artifactregistry      â”‚
â”‚    .admin                â”‚  â”‚    .admin                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                              â”‚
             â”‚ Manages Resources            â”‚
             â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Terraform (IaC)                                   â”‚
â”‚                    Infrastructure as Code                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  State Storage: GCS Bucket (with versioning)                             â”‚
â”‚    â€¢ dev-ai-agents-projects-terraform-state                              â”‚
â”‚    â€¢ terraform/state/dev/default.tfstate                                 â”‚
â”‚    â€¢ terraform/state/prod/default.tfstate                                â”‚
â”‚                                                                           â”‚
â”‚  Modules:                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚    â”‚  IAM Module  â”‚  â”‚ Secret Mgr   â”‚  â”‚  Cloud Run   â”‚               â”‚
â”‚    â”‚              â”‚  â”‚   Module     â”‚  â”‚   Module     â”‚               â”‚
â”‚    â”‚ â€¢ Service    â”‚  â”‚              â”‚  â”‚              â”‚               â”‚
â”‚    â”‚   Accounts   â”‚  â”‚ â€¢ Secrets    â”‚  â”‚ â€¢ Service    â”‚               â”‚
â”‚    â”‚ â€¢ IAM        â”‚  â”‚ â€¢ Versions   â”‚  â”‚ â€¢ Config     â”‚               â”‚
â”‚    â”‚   Bindings   â”‚  â”‚ â€¢ Access     â”‚  â”‚ â€¢ Health     â”‚               â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚    â”‚ Monitoring   â”‚                                                      â”‚
â”‚    â”‚   Module     â”‚                                                      â”‚
â”‚    â”‚              â”‚                                                      â”‚
â”‚    â”‚ â€¢ Alerts     â”‚                                                      â”‚
â”‚    â”‚ â€¢ Dashboards â”‚                                                      â”‚
â”‚    â”‚ â€¢ Log Sinks  â”‚                                                      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Provisions/Updates
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   GCP Resources (Dev Environment)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Cloud Run: financia-api-dev                                      â”‚   â”‚
â”‚  â”‚    â€¢ Min instances: 0                                             â”‚   â”‚
â”‚  â”‚    â€¢ Max instances: 5                                             â”‚   â”‚
â”‚  â”‚    â€¢ Memory: 512Mi                                                â”‚   â”‚
â”‚  â”‚    â€¢ CPU: 1                                                       â”‚   â”‚
â”‚  â”‚    â€¢ Service Account: financia-app-dev@...                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Secret Manager                                                   â”‚   â”‚
â”‚  â”‚    â€¢ WHATSAPP_API_KEY_DEV                                        â”‚   â”‚
â”‚  â”‚    â€¢ GEMINI_API_KEY_DEV                                          â”‚   â”‚
â”‚  â”‚    â€¢ GOOGLE_CLIENT_ID_DEV                                        â”‚   â”‚
â”‚  â”‚    â€¢ GOOGLE_CLIENT_SECRET_DEV                                    â”‚   â”‚
â”‚  â”‚    â€¢ GOOGLE_REFRESH_TOKEN_DEV                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  IAM                                                              â”‚   â”‚
â”‚  â”‚    Service Account: financia-app-dev@...                         â”‚   â”‚
â”‚  â”‚    Roles:                                                         â”‚   â”‚
â”‚  â”‚      â€¢ secretmanager.secretAccessor                              â”‚   â”‚
â”‚  â”‚      â€¢ logging.logWriter                                          â”‚   â”‚
â”‚  â”‚      â€¢ monitoring.metricWriter                                    â”‚   â”‚
â”‚  â”‚      â€¢ errorreporting.writer                                      â”‚   â”‚
â”‚  â”‚      â€¢ cloudtrace.agent                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   GCP Resources (Prod Environment)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Cloud Run: financia-api                                          â”‚   â”‚
â”‚  â”‚    â€¢ Min instances: 1 (keep warm)                                â”‚   â”‚
â”‚  â”‚    â€¢ Max instances: 20                                            â”‚   â”‚
â”‚  â”‚    â€¢ Memory: 512Mi                                                â”‚   â”‚
â”‚  â”‚    â€¢ CPU: 1                                                       â”‚   â”‚
â”‚  â”‚    â€¢ Service Account: financia-app-prod@...                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Secret Manager                                                   â”‚   â”‚
â”‚  â”‚    â€¢ WHATSAPP_API_KEY_PROD                                       â”‚   â”‚
â”‚  â”‚    â€¢ GEMINI_API_KEY_PROD                                         â”‚   â”‚
â”‚  â”‚    â€¢ GOOGLE_CLIENT_ID_PROD                                       â”‚   â”‚
â”‚  â”‚    â€¢ GOOGLE_CLIENT_SECRET_PROD                                   â”‚   â”‚
â”‚  â”‚    â€¢ GOOGLE_REFRESH_TOKEN_PROD                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Monitoring                                                       â”‚   â”‚
â”‚  â”‚    â€¢ Alert: High Error Rate (>5%)                                â”‚   â”‚
â”‚  â”‚    â€¢ Alert: High Latency (P95 >5s)                               â”‚   â”‚
â”‚  â”‚    â€¢ Alert: Service Down (no requests in 5min)                   â”‚   â”‚
â”‚  â”‚    â€¢ Dashboard: Request Count, Latency, Errors                   â”‚   â”‚
â”‚  â”‚    â€¢ Notification: Email alerts                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        External Services                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  WhatsApp    â”‚  â”‚  Google      â”‚  â”‚  Google      â”‚                  â”‚
â”‚  â”‚  Business    â”‚  â”‚  Gemini API  â”‚  â”‚  Sheets API  â”‚                  â”‚
â”‚  â”‚  API         â”‚  â”‚              â”‚  â”‚              â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                 â”‚                 â”‚                            â”‚
â”‚         â”‚                 â”‚                 â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Financia Application        â”‚
            â”‚  (Cloud Run Service)         â”‚
            â”‚                              â”‚
            â”‚  Agents:                     â”‚
            â”‚    â€¢ Intent Recognition      â”‚
            â”‚    â€¢ Entity Extraction       â”‚
            â”‚    â€¢ Speech Transcription    â”‚
            â”‚    â€¢ Data Persistence        â”‚
            â”‚    â€¢ Response Generation     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Security Flow

```
GitHub Actions
      â”‚
      â”‚ 1. Request OIDC token from GitHub
      â–¼
GitHub OIDC Provider
      â”‚
      â”‚ 2. Issue signed JWT with claims
      â”‚    (repository, actor, workflow, etc.)
      â–¼
GCP Workload Identity Federation
      â”‚
      â”‚ 3. Validate JWT signature
      â”‚ 4. Check attribute conditions
      â”‚ 5. Map claims to Google identity
      â–¼
Service Account Token Service
      â”‚
      â”‚ 6. Issue short-lived access token
      â”‚    (valid for ~1 hour)
      â–¼
Terraform / gcloud CLI
      â”‚
      â”‚ 7. Use access token for API calls
      â–¼
GCP Resources
      â”‚
      â”‚ 8. Verify permissions via IAM
      â”‚ 9. Execute requested operations
      â–¼
Infrastructure Changes Applied

âœ… No secrets stored in GitHub
âœ… No JSON keys to rotate
âœ… Automatic token expiration
âœ… Audit trail via Cloud Logging
```

## ğŸ“Š Deployment Flow (Dev)

```
Developer
    â”‚
    â”‚ 1. Create feature branch
    â”‚    git checkout -b feature/new-feature
    â–¼
Make Changes to Terraform
    â”‚
    â”‚ 2. Commit and push
    â”‚    git push origin feature/new-feature
    â–¼
Create Pull Request
    â”‚
    â”‚ 3. Triggers GitHub Actions
    â–¼
Terraform Plan Workflow
    â”‚
    â”œâ”€ Authenticate via OIDC
    â”œâ”€ terraform init
    â”œâ”€ terraform plan
    â”‚
    â”‚ 4. Posts plan as PR comment
    â–¼
Review Plan Output
    â”‚
    â”‚ 5. Team reviews changes
    â”‚ 6. Approve PR
    â–¼
Merge to Main
    â”‚
    â”‚ 7. Navigate to Actions â†’ Terraform Apply (Dev)
    â–¼
Manual Trigger
    â”‚
    â”‚ 8. Type "apply" to confirm
    â–¼
Terraform Apply Workflow
    â”‚
    â”œâ”€ Authenticate via OIDC
    â”œâ”€ terraform init
    â”œâ”€ terraform plan
    â”œâ”€ terraform apply
    â”‚
    â”‚ 9. Deploy to Cloud Run
    â–¼
Dev Environment Updated
    â”‚
    â”‚ 10. Run smoke tests
    â”‚ 11. Verify health endpoint
    â–¼
Deployment Complete âœ…
```

## ğŸ“Š Deployment Flow (Prod)

```
Tested in Dev âœ…
    â”‚
    â”‚ 1. Create PR to main branch
    â–¼
Terraform Plan Workflow (Prod)
    â”‚
    â”œâ”€ Authenticate via OIDC
    â”œâ”€ terraform plan (prod config)
    â”‚
    â”‚ 2. Posts plan as PR comment
    â”‚ 3. âš ï¸ Review carefully! This is PROD
    â–¼
Merge to Main (requires approval)
    â”‚
    â”‚ 4. Navigate to Actions â†’ Terraform Apply (Prod)
    â–¼
Manual Trigger
    â”‚
    â”‚ 5. Type "apply-prod" to confirm
    â–¼
Awaiting Approval
    â”‚
    â”‚ 6. Designated reviewer approves
    â”‚    (Required by environment protection rules)
    â–¼
Terraform Apply Workflow
    â”‚
    â”œâ”€ Authenticate via OIDC
    â”œâ”€ terraform init
    â”œâ”€ terraform plan
    â”œâ”€ terraform apply
    â”‚
    â”‚ 7. Deploy to Cloud Run
    â–¼
Production Environment Updated
    â”‚
    â”‚ 8. Run smoke tests
    â”‚    â”œâ”€ Health endpoint check
    â”‚    â””â”€ Webhook verification test
    â–¼
Deployment Complete âœ…
    â”‚
    â”‚ 9. Monitor logs and metrics
    â”‚ 10. Verify WhatsApp integration
    â–¼
Production Stable ğŸ‰
```

## ğŸ”„ State Management Flow

```
Terraform Command
      â”‚
      â–¼
Check GCS for State Lock
      â”‚
      â”œâ”€ Locked? â†’ Wait or fail
      â”‚
      â”œâ”€ Not locked? â†’ Acquire lock
      â–¼
Load Current State
      â”‚
      â”‚ From: gs://dev-ai-agents-projects-terraform-state/
      â”‚       terraform/state/{dev|prod}/default.tfstate
      â–¼
Compare with Desired State
      â”‚
      â”‚ (from .tf files + .tfvars)
      â–¼
Calculate Changes
      â”‚
      â”œâ”€ terraform plan: Show changes
      â”‚
      â”œâ”€ terraform apply: Execute changes
      â–¼
Update State File
      â”‚
      â”‚ 1. Upload new state to GCS
      â”‚ 2. Create new version (versioning enabled)
      â”‚ 3. Release lock
      â–¼
State Updated âœ…
      â”‚
      â”‚ Rollback available via GCS versioning:
      â”‚   gsutil cp gs://bucket/state.tfstate#version old.tfstate
      â–¼
```

---

**Key Takeaways:**

1. âœ… **No secrets in GitHub** - OIDC tokens only
2. âœ… **Automated planning** - Every PR gets a plan
3. âœ… **Manual deployments** - Explicit confirmation required
4. âœ… **Environment isolation** - Separate state, SAs, resources
5. âœ… **Audit trail** - All changes logged in GCP
6. âœ… **State versioning** - Rollback capability via GCS
7. âœ… **Multi-layer approval** - GitHub reviewers + manual trigger
8. âœ… **Smoke tests** - Automated health checks post-deploy
